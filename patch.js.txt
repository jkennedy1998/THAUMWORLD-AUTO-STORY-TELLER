import "dotenv/config";
import fs from "fs/promises";
import path from "path";
import { modify, applyEdits } from "jsonc-parser";

const ROOT = path.resolve(process.env.STATE_ROOT ?? "./state");

function safePath(rel) {
  const abs = path.resolve(ROOT, rel);
  if (!abs.startsWith(ROOT + path.sep)) throw new Error("Path outside STATE_ROOT");
  return abs;
}

async function applyJsonEdits(relPath, edits) {
  const abs = safePath(relPath);
  const before = await fs.readFile(abs, "utf8");
  let text = before;

  for (const e of edits) {
    const textEdits = modify(
      text,
      e.jsonPath,
      e.op === "remove" ? undefined : e.value,
      { formattingOptions: { insertSpaces: true, tabSize: 2, eol: "\n" } }
    );
    text = applyEdits(text, textEdits);
  }

  // validate
  JSON.parse(text);

  // atomic write
  const tmp = abs + ".tmp";
  await fs.writeFile(tmp, text, "utf8");
  await fs.rename(tmp, abs);
}

await applyJsonEdits("test.json", [
  { op: "replace", jsonPath: ["gold"], value: 4 },
  { op: "add", jsonPath: ["inventory", 0], value: { id: "ITEM_GLOWLEAF", qty: 1 } }
]);

console.log("ok");
