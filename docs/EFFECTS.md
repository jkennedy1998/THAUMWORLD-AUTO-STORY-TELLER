# THAUMWORLD Effect System

Complete reference for the THAUMWORLD RPG effect system implemented in the automated story teller.

**Game Reference:** [THAUMWORLD Rules](https://www.thaumworld.xyz/rules-index/)

## Overview

Effects are system commands that modify game state. They are generated by **rules_lawyer** and applied by **state_applier**.

**Effect Flow:**
```
Player Action → Rules Lawyer → Effects Generated → State Applier → Game State Modified
```

## Effect Syntax

All effects follow the pattern:
```
SYSTEM.<EFFECT_NAME>(target=<ref>, [parameters...])
```

**Example:**
```
SYSTEM.APPLY_DAMAGE(target=npc.goblin, amount=8)
SYSTEM.SET_AWARENESS(observer=npc.guard, target=actor.player)
SYSTEM.ADJUST_INVENTORY(target=actor.player, item=item.potion, delta=-1)
```

## Effect Categories

### 1. Health & Damage Effects

**Reference:** [Damage](https://www.thaumworld.xyz/damage/), [Health](https://www.thaumworld.xyz/health/)

#### SYSTEM.APPLY_DAMAGE
Subtract health from target.

**Syntax:**
```
SYSTEM.APPLY_DAMAGE(
    target=actor|npc.<id>,
    amount=<number>,
    [type=<damage_type>]
)
```

**Parameters:**
- `target`: Actor or NPC to damage
- `amount`: Health points to subtract
- `type`: Optional damage type (slashing, piercing, bludgeoning, fire, cold, etc.)

**Example:**
```
SYSTEM.APPLY_DAMAGE(target=npc.goblin, amount=8, type=slashing)
```

**Implementation:**
- Reduces `resources.health.current` by amount
- If health reaches 0: applies VIGOR damage and KNOCKED tag
- Creates WOUNDED tag if significant damage

**RPG Rules:**
- Damage subtracts from HEALTH by default
- Can target VIGOR or THAUM if specified
- At 0 HEALTH: take 1 VIGOR damage + gain KNOCKED

---

#### SYSTEM.APPLY_HEAL
Restore health to target.

**Syntax:**
```
SYSTEM.APPLY_HEAL(
    target=actor|npc.<id>,
    amount=<number>
)
```

**Parameters:**
- `target`: Actor or NPC to heal
- `amount`: Health points to restore

**Example:**
```
SYSTEM.APPLY_HEAL(target=actor.player, amount=5)
```

**Implementation:**
- Increases `resources.health.current` by amount
- Cannot exceed `resources.health.max`
- Removes WOUNDED tag if health above threshold

**RPG Rules:**
- Healing occurs during SLEEP or REPAIR extended actions
- Costs 1 VIGOR to heal (but also produces 1 VIGOR)
- Cannot heal when at 0 VIGOR

---

#### SYSTEM.APPLY_VIGOR_DAMAGE
Reduce vigor directly.

**Syntax:**
```
SYSTEM.APPLY_VIGOR_DAMAGE(
    target=actor|npc.<id>,
    amount=<number>
)
```

**Example:**
```
SYSTEM.APPLY_VIGOR_DAMAGE(target=actor.player, amount=1)
```

**Implementation:**
- Reduces `resources.vigor.current` by amount
- Minimum value: -1 (represents exhaustion)

**RPG Rules:**
- VIGOR represents life force/stamina
- At -1 VIGOR: character is exhausted, cannot heal
- VIGOR recovers during SLEEP/REPAIR

---

### 2. Awareness & Perception Effects

**Reference:** [Awareness](https://www.thaumworld.xyz/awareness/), [Senses](https://www.thaumworld.xyz/senses/)

#### SYSTEM.SET_AWARENESS
Set awareness state between observer and target.

**Syntax:**
```
SYSTEM.SET_AWARENESS(
    observer=actor|npc.<id>,
    target=actor|npc|tile.<id>,
    [clarity="clear"|"obscured"]
)
```

**Parameters:**
- `observer`: Entity becoming aware
- `target`: Entity being observed
- `clarity`: "clear" (default) or "obscured"

**Example:**
```
SYSTEM.SET_AWARENESS(observer=npc.guard, target=actor.player, clarity=clear)
SYSTEM.SET_AWARENESS(observer=npc.guard, target=actor.player, clarity=obscured)
```

**Implementation:**
- Adds awareness entry to observer's data
- Sets clarity level (affects perception detail)
- Triggers NPC response if player communicates

**RPG Rules:**
- Awareness based on SENSES (light, pressure, aroma, thaumic)
- Clear awareness: full details visible
- Obscured awareness: presence known, details unclear
- No awareness: entity invisible to observer

---

#### SYSTEM.REMOVE_AWARENESS
Remove awareness between entities.

**Syntax:**
```
SYSTEM.REMOVE_AWARENESS(
    observer=actor|npc.<id>,
    target=actor|npc.<id>
)
```

**Example:**
```
SYSTEM.REMOVE_AWARENESS(observer=npc.guard, target=actor.player)
```

**Implementation:**
- Removes awareness entry from observer's data
- Target becomes "invisible" to observer

---

### 3. Inventory & Equipment Effects

**Reference:** [Items & Inventory](https://www.thaumworld.xyz/items-n-inventory/)

#### SYSTEM.ADJUST_INVENTORY
Add or remove items from inventory.

**Syntax:**
```
SYSTEM.ADJUST_INVENTORY(
    target=actor|npc.<id>,
    item=item.<id>,
    delta=<number>,
    [container="inventory"|"hands"|"body"]
)
```

**Parameters:**
- `target`: Actor or NPC
- `item`: Item ID
- `delta`: Positive (add) or negative (remove) quantity
- `container`: Where to add/remove (default: inventory)

**Example:**
```
SYSTEM.ADJUST_INVENTORY(target=actor.player, item=item.gold_coin, delta=50)
SYSTEM.ADJUST_INVENTORY(target=actor.player, item=item.potion, delta=-1)
```

**Implementation:**
- Modifies inventory array in target's data
- Updates inventory weight
- Checks weight penalties

**RPG Rules:**
- Inventory has weight limit based on STR
- Excess weight causes WEIGHT PENALTY tag
- Hands and body slots are separate containers

---

#### SYSTEM.EQUIP_ITEM
Equip item to body slot.

**Syntax:**
```
SYSTEM.EQUIP_ITEM(
    target=actor|npc.<id>,
    item=item.<id>,
    slot=<slot_name>
)
```

**Parameters:**
- `target`: Actor or NPC
- `item`: Item ID
- `slot`: Body slot (head, body, hands, feet, etc.)

**Example:**
```
SYSTEM.EQUIP_ITEM(target=actor.player, item=item.leather_armor, slot=body)
```

**Implementation:**
- Moves item from inventory to equipment slot
- Applies item tags to character
- Updates AC, stats, etc.

---

#### SYSTEM.UNEQUIP_ITEM
Remove item from body slot.

**Syntax:**
```
SYSTEM.UNEQUIP_ITEM(
    target=actor|npc.<id>,
    slot=<slot_name>
)
```

**Example:**
```
SYSTEM.UNEQUIP_ITEM(target=actor.player, slot=body)
```

---

### 4. Resource Effects

#### SYSTEM.ADJUST_RESOURCE
Modify any resource value.

**Syntax:**
```
SYSTEM.ADJUST_RESOURCE(
    target=actor|npc|item.<id>,
    resource=<resource_name>,
    delta=<number>,
    [field=<field_name>]
)
```

**Parameters:**
- `target`: Entity with resource
- `resource`: Resource name (health, vigor, thaum, durability, etc.)
- `delta`: Amount to adjust (+ or -)
- `field`: Specific field (current, max, etc.)

**Example:**
```
SYSTEM.ADJUST_RESOURCE(target=actor.player, resource=vigor, delta=-1)
SYSTEM.ADJUST_RESOURCE(target=item.sword, resource=durability, delta=-1, field=current)
SYSTEM.ADJUST_RESOURCE(target=actor.player, resource=actions, delta=-1, field=current)
```

**Implementation:**
- Modifies resource value
- Respects min/max bounds
- Updates derived stats if needed

**Common Resources:**
- `health.current` / `health.max`
- `vigor.current` / `vigor.max`
- `actions.current` / `actions.max`
- `thaum.current` / `thaum.max`
- `durability.current` (items)

---

### 5. Tag Effects

**Reference:** [Tags](https://www.thaumworld.xyz/tags/)

#### SYSTEM.APPLY_TAG
Add tag to target.

**Syntax:**
```
SYSTEM.APPLY_TAG(
    target=actor|npc|item|tile.<id>,
    tag=<tag_name>,
    [stacks=<number>],
    [duration=<turns>]
)
```

**Parameters:**
- `target`: Entity to tag
- `tag`: Tag name
- `stacks`: Number of stacks (default: 1)
- `duration`: Turns until tag expires (optional)

**Example:**
```
SYSTEM.APPLY_TAG(target=npc.goblin, tag=POISONED, stacks=3, duration=5)
SYSTEM.APPLY_TAG(target=actor.player, tag=KNOCKED, stacks=5)
SYSTEM.APPLY_TAG(target=actor.player, tag=INVISIBLE, duration=10)
```

**Implementation:**
- Adds tag to target's tags array
- Tracks stacks and duration
- Applies tag effects (modifiers, etc.)

**Common Tags:**
- `KNOCKED` - Prone, can't act
- `POISONED` - Takes damage over time
- `INVISIBLE` - Can't be seen
- `WOUNDED` - Reduced max health
- `BURNING` - Fire damage over time
- `FROZEN` - Can't move

---

#### SYSTEM.REMOVE_TAG
Remove tag from target.

**Syntax:**
```
SYSTEM.REMOVE_TAG(
    target=actor|npc|item|tile.<id>,
    tag=<tag_name>,
    [stacks=<number>]
)
```

**Parameters:**
- `target`: Entity to untag
- `tag`: Tag name
- `stacks`: Stacks to remove (default: all)

**Example:**
```
SYSTEM.REMOVE_TAG(target=actor.player, tag=POISONED)
SYSTEM.REMOVE_TAG(target=actor.player, tag=KNOCKED, stacks=2)
```

---

### 6. Position & Movement Effects

**Reference:** [Movement](https://www.thaumworld.xyz/movement/), [Tiles](https://www.thaumworld.xyz/tiles-n-occupied/)

#### SYSTEM.SET_OCCUPANCY
Claim or release tile occupancy.

**Syntax:**
```
SYSTEM.SET_OCCUPANCY(
    target=actor|npc.<id>,
    tile=tile.<x>.<y>,
    action="claim"|"release"
)
```

**Parameters:**
- `target`: Entity occupying/releasing
- `tile`: Tile coordinates
- `action`: "claim" or "release"

**Example:**
```
SYSTEM.SET_OCCUPANCY(target=actor.player, tile=tile.5.12, action=claim)
SYSTEM.SET_OCCUPANCY(target=actor.player, tile=tile.5.11, action=release)
```

**Implementation:**
- Updates tile.occupied_by field
- Prevents multiple entities on same tile
- Updates entity location

---

#### SYSTEM.MOVE_ENTITY
Move entity to new location.

**Syntax:**
```
SYSTEM.MOVE_ENTITY(
    target=actor|npc.<id>,
    destination=tile.<x>.<y>|region_tile.<x>.<y>
)
```

**Example:**
```
SYSTEM.MOVE_ENTITY(target=actor.player, destination=tile.10.15)
```

**Implementation:**
- Updates entity location fields
- Releases old tile occupancy
- Claims new tile occupancy

---

### 7. Time & Turn Effects

#### SYSTEM.ADVANCE_TIME
Advance game time.

**Syntax:**
```
SYSTEM.ADVANCE_TIME(
    turns=<number>,
    [extended_actions=<number>]
)
```

**Parameters:**
- `turns`: Number of turns to advance
- `extended_actions`: Number of extended actions (optional)

**Example:**
```
SYSTEM.ADVANCE_TIME(turns=1)
SYSTEM.ADVANCE_TIME(turns=6, extended_actions=1)  // 1 hour sleep
```

**Implementation:**
- Updates world timestamp
- Processes time-based effects (poison, etc.)
- Reduces effect durations
- Triggers timed events

---

## Effect Application Order

**Reference:** [Effectors](https://www.thaumworld.xyz/effectors/)

When multiple effects apply to the same roll or value:

1. **Base Value** (NAT ROLL or current value)
2. **SHIFT** (additive) - From tags, perks, bonuses
3. **SCALE** (multiplicative) - From tags, perks
4. **Caps** - Min/max limits from rules

**Example:**
```
Base Damage: 8
+ SHIFT (strength bonus): +2
× SCALE (critical hit): ×2
= Final Damage: 20
```

## Effect Implementation Guide

### Adding a New Effect

**Step 1:** Document in this file

**Step 2:** Add parser support in `src/system_syntax/index.ts`
```typescript
const VALID_EFFECTS = [
    'SYSTEM.APPLY_DAMAGE',
    'SYSTEM.APPLY_HEAL',
    'SYSTEM.YOUR_NEW_EFFECT',  // Add here
];
```

**Step 3:** Add rules lawyer handler in `src/rules_lawyer/effects.ts`
```typescript
function handleYourEffect(command: CommandNode, ...): void {
    // Validation
    // Effect generation
    effect_lines.push(`SYSTEM.YOUR_EFFECT(...)`);
}
```

**Step 4:** Add state applier implementation in `src/state_applier/apply.ts`
```typescript
function applyYourEffect(command: CommandNode, ...): ApplyResult {
    // Load target
    // Apply changes
    // Save target
    // Return diffs
}
```

**Step 5:** Test
```bash
npm run dev
# Trigger effect in game
# Check logs with DEBUG_LEVEL=3
```

## Effect Diffs

State applier returns `AppliedDiff` objects:

```typescript
type AppliedDiff = {
    effect_id: string;      // Unique ID for deduplication
    target: string;         // Target reference
    field: string;          // Field modified (e.g., "health.current")
    delta: number;          // Change amount (+ or -)
    reason: string;         // Human-readable reason
};
```

**Example Diff:**
```jsonc
{
    "effect_id": "damage:npc.goblin:8:2026-01-31",
    "target": "npc.goblin",
    "field": "health.current",
    "delta": -8,
    "reason": "Sword attack from actor.player"
}
```

## Common Effect Patterns

### Damage with Tag
```
SYSTEM.APPLY_DAMAGE(target=npc.goblin, amount=5)
SYSTEM.APPLY_TAG(target=npc.goblin, tag=BLEEDING, stacks=2, duration=3)
```

### Healing
```
SYSTEM.APPLY_HEAL(target=actor.player, amount=10)
SYSTEM.REMOVE_TAG(target=actor.player, tag=WOUNDED)
```

### Communication
```
SYSTEM.SET_AWARENESS(observer=npc.shopkeep, target=actor.player, clarity=clear)
```

### Item Usage
```
SYSTEM.ADJUST_INVENTORY(target=actor.player, item=item.potion, delta=-1)
SYSTEM.APPLY_HEAL(target=actor.player, amount=20)
```

### Equipment Change
```
SYSTEM.UNEQUIP_ITEM(target=actor.player, slot=body)
SYSTEM.EQUIP_ITEM(target=actor.player, item=item.chain_mail, slot=body)
```

## Debugging Effects

### View Effects in Log
```bash
# See all effects in a ruling
cat local_data/data_slot_1/log.jsonc | grep "effects"

# See applied effects
cat local_data/data_slot_1/log.jsonc | grep "effects_applied"
```

### Debug Effect Application
```bash
# Run with debug logging
set DEBUG_LEVEL=3
npm run dev

# Watch for:
# [StateApplier] APPLIED X effects
# [StateApplier] data change to ...
```

### Check Effect Diffs
```bash
# See detailed diffs
cat local_data/data_slot_1/log.jsonc | jq '.messages | map(select(.sender == "state_applier"))'
```

## Next Steps

- See [SERVICES.md](./SERVICES.md) for service details
- See [STAGES.md](./STAGES.md) for message flow
- See [examples/](./examples/) for implementation examples
- Reference [THAUMWORLD Rules](https://www.thaumworld.xyz/rules-index/) for game mechanics